<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Game Pinguin Lompat Es</title>
    <style>
        :root {
            --primary: #4A90E2;
            --secondary: #FFC107;
            --bg: #E3F2FD;
            --text: #333;
        }
        body {
            font-family: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            text-align: center;
            margin: 0;
            padding: 20px;
            overflow: hidden; 
            touch-action: none; 
        }
        h1 {
            color: var(--primary);
            margin-bottom: 5px;
        }
        #instruction-text {
            color: #555;
            margin-bottom: 20px;
            font-size: 1.1em;
        }
        canvas {
            background-color: #B3E5FC;
            border: 4px solid white;
            border-radius: 15px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            max-width: 100%;
            cursor: pointer;
        }
        .modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            z-index: 1000;
            width: 300px;
            border: 5px solid var(--primary);
        }
        .modal-title {
            font-size: 1.5em;
            color: #E53935;
            margin-top: 0;
        }
        .math-question {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            margin: 20px 0;
        }
        input[type="number"] {
            width: 80%;
            padding: 10px;
            font-size: 1.5em;
            text-align: center;
            border: 2px solid var(--primary);
            border-radius: 10px;
            margin-bottom: 20px;
            font-family: inherit;
        }
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1.2em;
            border-radius: 10px;
            cursor: pointer;
            font-family: inherit;
            margin: 5px;
            width: 90%;
            transition: 0.2s;
        }
        .btn-secondary {
            background: #9E9E9E;
        }
        .btn-success {
            background: #4CAF50;
        }
        .btn:hover:not(:disabled) {
            opacity: 0.9;
            transform: scale(1.02);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        #overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 999;
        }
        .score-board {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 10px;
        }
        .fact-text {
            font-size: 1.2em;
            line-height: 1.5;
            color: #333;
            margin-bottom: 20px;
            background: #FFF9C4;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <h1>üêß Petualangan Pingu!</h1>
    <p id="instruction-text">Memuat panduan...</p>

    <div class="score-board">Skor: <span id="score">0</span></div>
    
    <canvas id="gameCanvas" width="800" height="300"></canvas>

    <div id="overlay"></div>

    <div id="start-modal" class="modal">
        <h2 style="color: var(--primary); margin-top: 0;">Siap Bermain? üéÆ</h2>
        <p>Bantu Pingu melompati rintangan es sambil menunggu waktu berbuka puasa!</p>
        <button class="btn btn-success" onclick="startGame()">‚ñ∂Ô∏è Mulai Game</button>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">Kembali ke Tracker Puasa</button>
    </div>

    <div id="fact-modal" class="modal">
        <h2 style="color: var(--primary); margin-top: 0;">Tahukah Kamu? üí°</h2>
        <div id="fact-content" class="fact-text">Fakta puasa ada di sini.</div>
        <button id="btn-continue-fact" class="btn btn-secondary" disabled>Tunggu sebentar...</button>
    </div>

    <div id="math-modal" class="modal">
        <h2 class="modal-title">Yah, Nabrak Es! üßä</h2>
        <p>Mau main lagi sekarang? Jawab soal matematika ini dulu ya!</p>
        <div class="math-question" id="question-text">5 + 3 = ?</div>
        <input type="number" id="math-answer" placeholder="Jawab...">
        <br>
        <button class="btn" onclick="checkMath()">Cek Jawaban!</button>
        <button class="btn btn-secondary" onclick="comeBackTomorrow()">Besok Aja Deh</button>
        <p id="math-feedback" style="color: red; display: none; margin-top: 10px;">Jawaban kurang tepat, coba lagi!</p>
    </div>

    <div id="locked-modal" class="modal">
        <h2 style="color: var(--primary); margin-top: 0;">Sampai Jumpa Besok! üåô</h2>
        <p>Pingu mau istirahat dulu ya. Silakan kembali besok untuk bermain lagi!</p>
        <button class="btn btn-secondary" onclick="window.location.href='index.html'">Kembali ke Tracker Puasa</button>
    </div>

    <script>
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        
        const isTouchDevice = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
        const instructionText = document.getElementById('instruction-text');
        
        if (isTouchDevice) {
            instructionText.innerHTML = "<strong>üëÜ Tap layar di mana saja untuk melompat!</strong>";
        } else {
            instructionText.innerHTML = "Tekan <strong>SPASI</strong> atau klik layar untuk melompat.";
        }

        // Kumpulan Fakta Puasa Anak
        const fastingFacts = [
            "Puasa itu bikin tubuh kita jadi super bersih dari dalam loh, seperti pahlawan yang mengusir kuman jahat di perut kita!",
            "Dengan berpuasa, perut kita istirahat sebentar. Mesin pencernaan di dalam perut jadi lebih awet dan sehat.",
            "Puasa mengajarkan kita untuk lebih sabar dan mengendalikan amarah. Pingu aja sabar nunggu bedug maghrib!",
            "Orang yang sedang puasa itu doanya sangat mudah dikabulkan sama Allah. Yuk banyak-banyak berdoa yang baik-baik!",
            "Saat berbuka puasa, memakan kurma sangat bagus karena rasa manis alaminya bisa mengembalikan tenaga kita dengan cepat.",
            "Berpuasa bikin kita lebih peka dan peduli sama teman-teman kita di luar sana yang kesulitan mencari makanan.",
            "Nabi Muhammad SAW sangat suka berbuka puasa dengan makanan yang manis alami dan minum air putih yang segar.",
            "Tidur siang sebentar saat puasa juga bisa dihitung ibadah loh, asal jangan kebablasan sampai sore ya!"
        ];

        let frames = 0;
        let score = 0;
        let lastFactScore = 0; // Menyimpan histori skor kelipatan 100 terakhir
        let isGameOver = false;
        let gameStarted = false; 
        let gameSpeed = 5;
        let animationId;
        let countdownTimer;

        let todayDate = new Date().toDateString();
        let lockedDate = localStorage.getItem('pinguLockedDate');

        const pinguin = {
            x: 50,
            y: 200,
            width: 40,
            height: 40,
            dy: 0,
            jumpForce: -12,
            gravity: 0.6,
            grounded: false,
            
            draw() {
                ctx.font = "40px Arial";
                ctx.textBaseline = "top";
                ctx.fillText("üêß", this.x, this.y);
            },
            
            jump() {
                if (this.grounded && !isGameOver && gameStarted) {
                    this.dy = this.jumpForce;
                    this.grounded = false;
                }
            },
            
            update() {
                this.y += this.dy;
                if (this.y + this.height < 250) {
                    this.dy += this.gravity;
                    this.grounded = false;
                } else {
                    this.dy = 0;
                    this.y = 250 - this.height; 
                    this.grounded = true;
                }
                this.draw();
            }
        };

        const obstacles = [];
        
        function handleObstacles() {
            if (frames % 100 === 0) {
                let obsHeight = Math.random() * (60 - 30) + 30; 
                obstacles.push({
                    x: canvas.width,
                    y: 250 - obsHeight,
                    width: 30,
                    height: obsHeight
                });
            }
            
            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= gameSpeed;
                
                ctx.fillStyle = "white";
                ctx.fillRect(obs.x, obs.y, obs.width, obs.height);
                ctx.strokeStyle = "#81D4FA";
                ctx.lineWidth = 3;
                ctx.strokeRect(obs.x, obs.y, obs.width, obs.height);
                
                if (
                    pinguin.x < obs.x + obs.width &&
                    pinguin.x + pinguin.width - 10 > obs.x &&
                    pinguin.y < obs.y + obs.height &&
                    pinguin.y + pinguin.height > obs.y
                ) {
                    isGameOver = true;
                }
                
                if (obs.x + obs.width < 0) {
                    obstacles.splice(i, 1);
                    score += 10;
                    document.getElementById('score').innerText = score;
                    i--;

                    // CEK SKOR KELIPATAN 100 UNTUK POPUP FAKTA
                    if (score > 0 && score % 100 === 0 && score !== lastFactScore) {
                        lastFactScore = score;
                        triggerFactPopup();
                    }
                }
            }
        }

        function drawGround() {
            ctx.fillStyle = "#E0F7FA";
            ctx.fillRect(0, 250, canvas.width, 50);
            ctx.strokeStyle = "#4DD0E1";
            ctx.beginPath();
            ctx.moveTo(0, 250);
            ctx.lineTo(canvas.width, 250);
            ctx.stroke();
        }

        function animate() {
            if (isGameOver) {
                cancelAnimationFrame(animationId);
                triggerMathChallenge();
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGround();
            pinguin.update();
            handleObstacles();
            
            if (frames % 500 === 0 && gameSpeed < 10) gameSpeed += 0.5;
            
            frames++;
            animationId = requestAnimationFrame(animate);
        }

        // Kontrol Sentuhan & Tombol
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault(); 
                pinguin.jump();
            }
        });

        window.addEventListener('touchstart', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                pinguin.jump();
            }
        });

        window.addEventListener('mousedown', (e) => {
            if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                pinguin.jump();
            }
        });

        // Alur Game
        function startGame() {
            document.getElementById('start-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            gameStarted = true;
            animate();
        }

        // Logika Popup Fakta Puasa
        function triggerFactPopup() {
            // Hentikan permainan sejenak
            cancelAnimationFrame(animationId);
            gameStarted = false; 

            document.getElementById('overlay').style.display = 'block';
            document.getElementById('fact-modal').style.display = 'block';

            // Ambil fakta acak
            let randomFact = fastingFacts[Math.floor(Math.random() * fastingFacts.length)];
            document.getElementById('fact-content').innerText = randomFact;

            // Hitung estimasi waktu baca (Asumsi 2 kata per detik untuk anak-anak)
            let wordCount = randomFact.split(" ").length;
            let readTimeSeconds = Math.max(3, Math.ceil(wordCount / 2)); // Minimal 3 detik

            let btnContinue = document.getElementById('btn-continue-fact');
            btnContinue.disabled = true;
            btnContinue.classList.remove('btn-success');
            btnContinue.classList.add('btn-secondary');
            btnContinue.innerText = `Lanjut Main (${readTimeSeconds} detik)`;

            // Countdown Timer
            countdownTimer = setInterval(() => {
                readTimeSeconds--;
                if (readTimeSeconds > 0) {
                    btnContinue.innerText = `Lanjut Main (${readTimeSeconds} detik)`;
                } else {
                    clearInterval(countdownTimer);
                    btnContinue.disabled = false;
                    btnContinue.classList.remove('btn-secondary');
                    btnContinue.classList.add('btn-success');
                    btnContinue.innerText = "‚ñ∂Ô∏è Lanjut Main!";
                    btnContinue.onclick = resumeGame; // Pasang fungsi klik saat waktu habis
                }
            }, 1000);
        }

        function resumeGame() {
            document.getElementById('fact-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            gameStarted = true;
            animate(); // Lanjutkan game dari titik terakhir
        }

        let currentAnswer = 0;

        function triggerMathChallenge() {
            gameStarted = false; 
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('math-modal').style.display = 'block';
            document.getElementById('math-feedback').style.display = 'none';
            document.getElementById('math-answer').value = '';
            
            let num1 = Math.floor(Math.random() * 10) + 1;
            let num2 = Math.floor(Math.random() * 10) + 1;
            currentAnswer = num1 + num2;
            
            document.getElementById('question-text').innerText = `${num1} + ${num2} = ?`;
        }

        function checkMath() {
            let userAnswer = parseInt(document.getElementById('math-answer').value);
            if (userAnswer === currentAnswer) {
                document.getElementById('math-modal').style.display = 'none';
                document.getElementById('overlay').style.display = 'none';
                restartGame();
            } else {
                document.getElementById('math-feedback').style.display = 'block';
            }
        }

        function comeBackTomorrow() {
            localStorage.setItem('pinguLockedDate', todayDate);
            document.getElementById('math-modal').style.display = 'none';
            document.getElementById('locked-modal').style.display = 'block';
        }

        function restartGame() {
            obstacles.length = 0;
            pinguin.y = 200;
            pinguin.dy = 0;
            frames = 0;
            score = 0;
            lastFactScore = 0; // Reset histori skor fakta
            gameSpeed = 5;
            document.getElementById('score').innerText = score;
            isGameOver = false;
            gameStarted = true;
            animate();
        }

        window.onload = () => {
            drawGround();
            pinguin.draw();
            
            document.getElementById('overlay').style.display = 'block';
            
            if (lockedDate === todayDate) {
                document.getElementById('locked-modal').style.display = 'block';
            } else {
                document.getElementById('start-modal').style.display = 'block';
            }
        };

    </script>
</body>
</html>
